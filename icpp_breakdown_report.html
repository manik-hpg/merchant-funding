<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IC++ Pricing Breakdown - Regional Analysis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 50px;
        }

        .header h1 {
            font-size: 42px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2);
        }

        .header p {
            font-size: 18px;
            opacity: 0.9;
        }

        .stats-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #667eea;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: 700;
            color: #333;
        }

        .regions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 40px;
        }

        .region-card {
            background: white;
            border-radius: 20px;
            padding: 35px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .region-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
        }

        .region-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 3px solid #f0f0f0;
        }

        .region-title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .region-flag {
            font-size: 36px;
        }

        .region-name {
            font-size: 28px;
            font-weight: 700;
            color: #333;
        }

        .region-code {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .region-stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 25px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 12px;
        }

        .region-stat {
            text-align: center;
        }

        .region-stat-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .region-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #333;
        }

        .fee-breakdown {
            margin-top: 25px;
        }

        .fee-item {
            margin-bottom: 15px;
        }

        .fee-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .fee-label {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fee-badge {
            background: #ffd700;
            color: #333;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
        }

        .fee-amount {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .fee-value {
            font-size: 18px;
            font-weight: 700;
            color: #333;
        }

        .fee-percentage {
            font-size: 14px;
            color: #888;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 8px;
        }

        .fee-bar {
            height: 8px;
            background: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
        }

        .fee-bar-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.8s ease;
        }

        .fee-bar-ic {
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
        }

        .fee-bar-first {
            background: linear-gradient(90deg, #f093fb 0%, #f5576c 100%);
        }

        .fee-bar-second {
            background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%);
        }

        .fee-tree {
            margin-left: 30px;
            border-left: 3px solid #e0e0e0;
            padding-left: 20px;
            margin-top: 15px;
        }

        .fee-tree-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #fafafa;
            border-radius: 8px;
            font-size: 14px;
        }

        .fee-tree-label {
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fee-tree-icon {
            color: #999;
        }

        .fee-tree-amount {
            font-weight: 600;
            color: #333;
        }

        .total-section {
            margin-top: 25px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            color: white;
        }

        .total-label {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .total-value {
            font-size: 32px;
            font-weight: 700;
        }

        .footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }

        .footer p {
            opacity: 0.8;
            font-size: 14px;
        }

        .alert {
            background: #fff3cd;
            border: 2px solid #ffc107;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            color: #856404;
        }

        .alert h3 {
            margin-bottom: 10px;
            color: #856404;
        }

        .clickable {
            cursor: pointer;
            position: relative;
        }

        .clickable:hover {
            background: #f8f9ff;
            border-radius: 8px;
        }

        .info-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin-left: 5px;
            cursor: help;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            max-width: 700px;
            max-height: 85vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideDown 0.3s;
            display: flex;
            flex-direction: column;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 24px;
        }

        .close {
            color: white;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: transform 0.2s;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .calculation-section {
            margin-bottom: 25px;
        }

        .calculation-section h3 {
            color: #667eea;
            font-size: 16px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: #f8f9ff;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .calc-label {
            font-weight: 600;
            color: #333;
        }

        .calc-value {
            font-family: 'Courier New', monospace;
            color: #667eea;
            font-weight: 600;
        }

        .column-tag {
            display: inline-block;
            background: #e8eaf6;
            color: #5e35b1;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            margin: 4px 4px 4px 0;
        }

        .formula-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            margin: 15px 0;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @media (max-width: 768px) {
            .regions-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 32px;
            }

            .modal-content {
                margin: 10% 15px;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>üí≥ IC++ Pricing Breakdown</h1>
            <p>Transparent Cost Analysis - Actual Data</p>
        </div>

        <!-- File Upload Section -->
        <div id="uploadSection" class="stat-card" style="max-width: 800px; margin: 0 auto 40px auto; padding: 40px;">
            <h3 style="font-size: 20px; margin-bottom: 20px; color: #667eea;">üìÇ Load Daily Funding Report</h3>

            <!-- Preset Selector -->
            <div style="margin-bottom: 25px;">
                <label style="display: block; font-weight: 600; margin-bottom: 10px; color: #333;">
                    üéØ Quick Load Presets:
                </label>
                <select id="presetSelector"
                    style="width: 100%; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 15px; background: white; cursor: pointer;">
                    <option value="">-- Select a preset report --</option>
                    <option
                        value="daily_funding_report__EID-8520028455_ theresalam@heroplusgroup.com_POW-344000000003747_2026-01-06.csv">
                        2026-01-06 (Theresa) - Latest</option>
                    <option
                        value="daily_funding_report__EID-8520028455_ronaldlam@heroplusgroup.com_POW-344000000003747_2025-12-23.csv">
                        2025-12-23 (Ronald)</option>
                    <option
                        value="daily_funding_report__EID-8520028455_ronaldlam@heroplusgroup.com_POW-344000000003747_2025-12-22.csv">
                        2025-12-22 (Ronald)</option>
                    <option
                        value="daily_funding_report__EID-8520028455_ronaldlam@heroplusgroup.com_POW-344000000003747_2025-12-18.csv">
                        2025-12-18 (Ronald)</option>
                    <option
                        value="daily_funding_report__EID-8520028455_ronaldlam@heroplusgroup.com_POW-344000000003747_2025-12-15.csv">
                        2025-12-15 (Ronald)</option>
                    <option
                        value="daily_funding_report__EID-600004504_ theresalam@heroplusgroup.com_POW-458000000000274_2026-01-06.csv">
                        2026-01-06 (EID-600004504)</option>
                </select>
                <button id="loadPresetBtn"
                    style="margin-top: 10px; width: 100%; padding: 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; transition: transform 0.2s;">
                    Load Selected Report
                </button>
            </div>

            <div style="text-align: center; margin: 20px 0; color: #888;">
                <span style="background: white; padding: 0 15px;">OR</span>
            </div>

            <!-- File Upload -->
            <div id="dropZone"
                style="border: 3px dashed #667eea; border-radius: 12px; padding: 40px; text-align: center; background: #f8f9ff; cursor: pointer; transition: all 0.3s;">
                <div style="font-size: 48px; margin-bottom: 15px;">üìÑ</div>
                <p style="font-size: 16px; color: #333; margin-bottom: 10px;">
                    <strong>Drag & Drop CSV here</strong> or click to browse
                </p>
                <p style="font-size: 14px; color: #888;">
                    NomuPay Daily Funding Report with 65 columns
                </p>
                <input type="file" id="fileInput" accept=".csv" style="display: none;">
            </div>
            <div id="uploadStatus" style="margin-top: 20px; display: none;">
                <div style="background: #4caf50; color: white; padding: 15px; border-radius: 8px; text-align: center;">
                    <strong>‚úì File loaded:</strong> <span id="fileName"></span>
                    <br>
                    <span id="fileStats"></span>
                </div>
            </div>
        </div>

        <div class="stats-overview">
            <div class="stat-card">
                <h3>Total Transactions</h3>
                <div class="value">2</div>
            </div>
            <div class="stat-card">
                <h3>Regions Analyzed</h3>
                <div class="value">1</div>
            </div>
            <div class="stat-card">
                <h3>Transactions Skipped</h3>
                <div class="value">171</div>
            </div>
            <div class="stat-card">
                <h3>Transparency</h3>
                <div class="value">100%</div>
            </div>
        </div>
        <div class="regions-grid">
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">
                        <span class="region-flag">üá≠üá∞</span>
                        <span class="region-name">Hong Kong</span>
                    </div>
                    <div class="region-code">HK</div>
                </div>

                <div class="region-stats">
                    <div class="region-stat">
                        <div class="region-stat-label">Volume</div>
                        <div class="region-stat-value">HK$150.00</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-label">Transactions</div>
                        <div class="region-stat-value">1</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-label">Card Type</div>
                        <div class="region-stat-value">CC</div>
                    </div>
                </div>

                <div class="fee-breakdown">
                    <div class="fee-item clickable" onclick="showModal('ic', 'HK', 'CC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üí± IC (Interchange)
                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$3.11</span>
                                <span class="fee-percentage">2.07%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-ic" style="width: 1413.6%"></div>
                        </div>
                    </div>

                    <div class="fee-item clickable" onclick="showModal('first', 'HK', 'CC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üè¶ 1st Plus (Scheme)

                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$0.15</span>
                                <span class="fee-percentage">0.10%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-first" style="width: 68.2%"></div>
                        </div>
                    </div>

                    <div class="fee-item clickable" onclick="showModal('second', 'HK', 'CC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üîß 2nd Plus (Acquirer)
                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$3.04</span>
                                <span class="fee-percentage">2.03%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-second" style="width: 1381.8%"></div>
                        </div>

                        <div class="fee-tree">
                            <div class="fee-tree-item">
                                <div class="fee-tree-label">
                                    <span class="fee-tree-icon">‚îú‚îÄ</span> Authorization Fee
                                </div>
                                <div class="fee-tree-amount">HK$0.04 (0.027%)</div>
                            </div>
                            <div class="fee-tree-item">
                                <div class="fee-tree-label">
                                    <span class="fee-tree-icon">‚îú‚îÄ</span> Clearing Fee
                                </div>
                                <div class="fee-tree-amount">HK$0.06 (0.040%)</div>
                            </div>
                            <div class="fee-tree-item">
                                <div class="fee-tree-label">
                                    <span class="fee-tree-icon">‚îî‚îÄ</span> Net Acquirer Markup
                                </div>
                                <div class="fee-tree-amount">HK$3.14 (2.093%)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="total-section">
                    <div class="total-label">Total MDR</div>
                    <div class="total-value">HK$0.22 (0.15%)</div>
                </div>
            </div>
            <div class="region-card">
                <div class="region-header">
                    <div class="region-title">
                        <span class="region-flag">üá≠üá∞</span>
                        <span class="region-name">Hong Kong</span>
                    </div>
                    <div class="region-code">HK</div>
                </div>

                <div class="region-stats">
                    <div class="region-stat">
                        <div class="region-stat-label">Volume</div>
                        <div class="region-stat-value">HK$100.00</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-label">Transactions</div>
                        <div class="region-stat-value">1</div>
                    </div>
                    <div class="region-stat">
                        <div class="region-stat-label">Card Type</div>
                        <div class="region-stat-value">DC</div>
                    </div>
                </div>

                <div class="fee-breakdown">
                    <div class="fee-item clickable" onclick="showModal('ic', 'HK', 'DC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üí± IC (Interchange)
                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$2.05</span>
                                <span class="fee-percentage">2.05%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-ic" style="width: 1366.7%"></div>
                        </div>
                    </div>

                    <div class="fee-item clickable" onclick="showModal('first', 'HK', 'DC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üè¶ 1st Plus (Scheme)

                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$0.10</span>
                                <span class="fee-percentage">0.10%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-first" style="width: 66.7%"></div>
                        </div>
                    </div>

                    <div class="fee-item clickable" onclick="showModal('second', 'HK', 'DC')">
                        <div class="fee-header">
                            <div class="fee-label">
                                üîß 2nd Plus (Acquirer)
                                <span class="info-icon">i</span>
                            </div>
                            <div class="fee-amount">
                                <span class="fee-value">HK$2.00</span>
                                <span class="fee-percentage">2.00%</span>
                            </div>
                        </div>
                        <div class="fee-bar">
                            <div class="fee-bar-fill fee-bar-second" style="width: 1333.3%"></div>
                        </div>

                        <div class="fee-tree">
                            <div class="fee-tree-item">
                                <div class="fee-tree-label">
                                    <span class="fee-tree-icon">‚îú‚îÄ</span> Clearing Fee
                                </div>
                                <div class="fee-tree-amount">HK$0.10 (0.100%)</div>
                            </div>
                            <div class="fee-tree-item">
                                <div class="fee-tree-label">
                                    <span class="fee-tree-icon">‚îî‚îÄ</span> Net Acquirer Markup
                                </div>
                                <div class="fee-tree-amount">HK$2.10 (2.100%)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="total-section">
                    <div class="total-label">Total MDR</div>
                    <div class="total-value">HK$0.15 (0.15%)</div>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>ü§ñ Generated with IC++ Pricing Breakdown Calculator</p>
            <p>100% Real Data ‚Ä¢ Complete Transparency ‚Ä¢ Detailed Cost Analysis</p>
        </div>
    </div>

    <!-- Modal -->
    <div id="calculationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Calculation Details</h2>
                <span class="close" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Content will be inserted by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        let csvData = null;

        // File upload handling
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const loadPresetBtn = document.getElementById('loadPresetBtn');
        const presetSelector = document.getElementById('presetSelector');

        // Load preset button handler
        loadPresetBtn.addEventListener('click', () => {
            const selectedFile = presetSelector.value;
            if (!selectedFile) {
                alert('Please select a report from the dropdown first');
                return;
            }

            loadPresetBtn.textContent = 'Loading...';
            loadPresetBtn.style.opacity = '0.7';

            // Try to fetch the file (works if HTML is served or opened locally with right permissions)
            fetch(selectedFile)
                .then(response => {
                    if (!response.ok) throw new Error('Could not load preset');
                    return response.text();
                })
                .then(text => {
                    parseCSV(text, selectedFile);
                    loadPresetBtn.textContent = 'Load Selected Report';
                    loadPresetBtn.style.opacity = '1';
                })
                .catch(error => {
                    alert('Could not auto-load preset. Please use drag & drop or click to browse instead.\n\nTip: The preset file is: ' + selectedFile);
                    loadPresetBtn.textContent = 'Load Selected Report';
                    loadPresetBtn.style.opacity = '1';
                });
        });

        // Highlight button on hover
        loadPresetBtn.addEventListener('mouseenter', () => {
            loadPresetBtn.style.transform = 'scale(1.02)';
        });
        loadPresetBtn.addEventListener('mouseleave', () => {
            loadPresetBtn.style.transform = 'scale(1)';
        });

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#764ba2';
            dropZone.style.background = '#e8eaf6';
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#f8f9ff';
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#667eea';
            dropZone.style.background = '#f8f9ff';
            const file = e.dataTransfer.files[0];
            if (file && file.name.endsWith('.csv')) {
                processFile(file);
            } else {
                alert('Please upload a CSV file');
            }
        });

        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        });

        function processFile(file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const text = e.target.result;
                parseCSV(text, file.name);
            };
            reader.readAsText(file);
        }

        function parseCSV(text, fileName) {
            const lines = text.split('\n');
            const headers = lines[0].split(',');

            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }

            csvData = data;

            // Show upload status
            document.getElementById('fileName').textContent = fileName;
            document.getElementById('fileStats').textContent = \`\${data.length} rows ‚Ä¢ \${headers.length} columns\`;
            document.getElementById('uploadStatus').style.display = 'block';

            // Process and update display
            processTransactions();
        }

        function processTransactions() {
            if (!csvData) return;

            // Filter and group transactions
            const stats = {};
            let totalProcessed = 0;
            let totalSkipped = 0;

            csvData.forEach(row => {
                const txnType = row['Transaction Type'] || '';
                const status = row['Transaction Status'] || '';
                const amount = parseFloat(row['Transaction Amount'] || 0);

                // Skip gateway events and non-approved transactions
                if (txnType === 'Gateway_Events' || status !== 'Approved' || amount === 0) {
                    totalSkipped++;
                    return;
                }

                // Identify region from account name
                const merchant = row['Account name'] || '';
                let region = 'UNKNOWN';
                if (merchant.includes('Hong Kong')) region = 'HK';
                else if (merchant.includes('Malaysia')) region = 'MY';
                else if (merchant.includes('Thailand')) region = 'TH';

                const cardType = row['Card Type'] || 'UNKNOWN';
                const currency = row['Transaction Currency'] || '';

                // Parse fees
                const mdr = parseFloat(row['MDR Amount'] || 0);
                const ic = parseFloat(row['Interchange Amount'] || 0);
                const scheme = parseFloat(row['Scheme Fee Bucket Amount'] || 0);

                const gateway = parseFloat(row['Gateway Fee Amount'] || 0);
                const auth = parseFloat(row['Authorization Amount'] || 0);
                const clearing = parseFloat(row['Clearing Amount'] || 0);
                const crossBorder = parseFloat(row['Cross Border Amount'] || 0);
                const crossCurrency = parseFloat(row['Cross Currency Amount'] || 0);
                const preauth = parseFloat(row['Preauthorization Amount'] || 0);
                const threeDS = parseFloat(row['Three Ds Amount'] || 0);
                const nonThreeDS = parseFloat(row['Non Three Ds Amount'] || 0);
                const vat = parseFloat(row['VAT Amount'] || 0);
                const wht = parseFloat(row['WHT Amount'] || 0);
                const grt = parseFloat(row['GRT Amount'] || 0);
                const st = parseFloat(row['ST Amount'] || 0);

                const secondPlus = mdr - ic - scheme;
                const knownComponents = gateway + auth + clearing + crossBorder + crossCurrency +
                                      preauth + threeDS + nonThreeDS + vat + wht + grt + st;
                const netMarkup = secondPlus - knownComponents;

                // Initialize region/card type if needed
                if (!stats[region]) stats[region] = {};
                if (!stats[region][cardType]) {
                    stats[region][cardType] = {
                        count: 0,
                        volume: 0,
                        ic: 0,
                        scheme: 0,
                        secondPlus: 0,
                        mdr: 0,
                        gateway: 0,
                        auth: 0,
                        clearing: 0,
                        crossBorder: 0,
                        crossCurrency: 0,
                        preauth: 0,
                        threeDS: 0,
                        nonThreeDS: 0,
                        vat: 0,
                        wht: 0,
                        grt: 0,
                        st: 0,
                        netMarkup: 0,
                        currency: currency
                    };
                }

                // Aggregate
                const bucket = stats[region][cardType];
                bucket.count++;
                bucket.volume += amount;
                bucket.ic += ic;
                bucket.scheme += scheme;
                bucket.secondPlus += secondPlus;
                bucket.mdr += mdr;
                bucket.gateway += gateway;
                bucket.auth += auth;
                bucket.clearing += clearing;
                bucket.crossBorder += crossBorder;
                bucket.crossCurrency += crossCurrency;
                bucket.preauth += preauth;
                bucket.threeDS += threeDS;
                bucket.nonThreeDS += nonThreeDS;
                bucket.vat += vat;
                bucket.wht += wht;
                bucket.grt += grt;
                bucket.st += st;
                bucket.netMarkup += netMarkup;

                totalProcessed++;
            });

            // Update display
            updateDisplay(stats, totalProcessed, totalSkipped);
        }

        function updateDisplay(stats, totalProcessed, totalSkipped) {
            // Update overview stats
            const totalRegions = Object.keys(stats).length;
            document.querySelector('.stats-overview').innerHTML = \`
                <div class="stat-card">
                    <h3>Total Transactions</h3>
                    <div class="value">\${totalProcessed}</div>
                </div>
                <div class="stat-card">
                    <h3>Regions Analyzed</h3>
                    <div class="value">\${totalRegions}</div>
                </div>
                <div class="stat-card">
                    <h3>Transactions Skipped</h3>
                    <div class="value">\${totalSkipped}</div>
                </div>
                <div class="stat-card">
                    <h3>Transparency</h3>
                    <div class="value">100%</div>
                </div>
            \`;

            // Generate region cards
            const regionsGrid = document.querySelector('.regions-grid');
            regionsGrid.innerHTML = '';

            const regionMeta = {
                'HK': { name: 'Hong Kong', flag: 'üá≠üá∞', symbol: 'HK$' },
                'MY': { name: 'Malaysia', flag: 'üá≤üáæ', symbol: 'RM' },
                'TH': { name: 'Thailand', flag: 'üáπüá≠', symbol: '‡∏ø' },
                'UNKNOWN': { name: 'Other', flag: 'üåê', symbol: '$' }
            };

            Object.keys(stats).sort().forEach(region => {
                Object.keys(stats[region]).sort().forEach(cardType => {
                    const data = stats[region][cardType];
                    const meta = regionMeta[region] || regionMeta['UNKNOWN'];

                    const icPct = data.volume ? Math.abs(data.ic / data.volume * 100) : 0;
                    const schemePct = data.volume ? Math.abs(data.scheme / data.volume * 100) : 0;
                    const secondPct = data.volume ? Math.abs(data.secondPlus / data.volume * 100) : 0;
                    const mdrPct = data.volume ? Math.abs(data.mdr / data.volume * 100) : 0;

                    const mdrAbs = Math.abs(data.mdr);
                    const icWidth = mdrAbs ? Math.abs(data.ic) / mdrAbs * 100 : 0;
                    const schemeWidth = mdrAbs ? Math.abs(data.scheme) / mdrAbs * 100 : 0;
                    const secondWidth = mdrAbs ? Math.abs(data.secondPlus) / mdrAbs * 100 : 0;

                    const card = document.createElement('div');
                    card.className = 'region-card';
                    card.innerHTML = \`
                        <div class="region-header">
                            <div class="region-title">
                                <span class="region-flag">\${meta.flag}</span>
                                <span class="region-name">\${meta.name}</span>
                            </div>
                            <div class="region-code">\${region}</div>
                        </div>

                        <div class="region-stats">
                            <div class="region-stat">
                                <div class="region-stat-label">Volume</div>
                                <div class="region-stat-value">\${meta.symbol}\${Math.abs(data.volume).toFixed(2)}</div>
                            </div>
                            <div class="region-stat">
                                <div class="region-stat-label">Transactions</div>
                                <div class="region-stat-value">\${data.count}</div>
                            </div>
                            <div class="region-stat">
                                <div class="region-stat-label">Card Type</div>
                                <div class="region-stat-value">\${cardType}</div>
                            </div>
                        </div>

                        <div class="fee-breakdown">
                            <div class="fee-item clickable" onclick="showModal('ic', '\${region}', '\${cardType}')">
                                <div class="fee-header">
                                    <div class="fee-label">
                                        üí± IC (Interchange)
                                        <span class="info-icon">i</span>
                                    </div>
                                    <div class="fee-amount">
                                        <span class="fee-value">\${meta.symbol}\${Math.abs(data.ic).toFixed(2)}</span>
                                        <span class="fee-percentage">\${icPct.toFixed(2)}%</span>
                                    </div>
                                </div>
                                <div class="fee-bar">
                                    <div class="fee-bar-fill fee-bar-ic" style="width: \${icWidth.toFixed(1)}%"></div>
                                </div>
                            </div>

                            <div class="fee-item clickable" onclick="showModal('first', '\${region}', '\${cardType}')">
                                <div class="fee-header">
                                    <div class="fee-label">
                                        üè¶ 1st Plus (Scheme)
                                        <span class="info-icon">i</span>
                                    </div>
                                    <div class="fee-amount">
                                        <span class="fee-value">\${meta.symbol}\${Math.abs(data.scheme).toFixed(2)}</span>
                                        <span class="fee-percentage">\${schemePct.toFixed(2)}%</span>
                                    </div>
                                </div>
                                <div class="fee-bar">
                                    <div class="fee-bar-fill fee-bar-first" style="width: \${schemeWidth.toFixed(1)}%"></div>
                                </div>
                            </div>

                            <div class="fee-item clickable" onclick="showModal('second', '\${region}', '\${cardType}')">
                                <div class="fee-header">
                                    <div class="fee-label">
                                        üîß 2nd Plus (Acquirer)
                                        <span class="info-icon">i</span>
                                    </div>
                                    <div class="fee-amount">
                                        <span class="fee-value">\${meta.symbol}\${Math.abs(data.secondPlus).toFixed(2)}</span>
                                        <span class="fee-percentage">\${secondPct.toFixed(2)}%</span>
                                    </div>
                                </div>
                                <div class="fee-bar">
                                    <div class="fee-bar-fill fee-bar-second" style="width: \${secondWidth.toFixed(1)}%"></div>
                                </div>

                                <div class="fee-tree">
                                    \${generateTreeItem('Gateway Fee', data.gateway, data.volume, meta.symbol)}
                                    \${generateTreeItem('Authorization Fee', data.auth, data.volume, meta.symbol)}
                                    \${generateTreeItem('Clearing Fee', data.clearing, data.volume, meta.symbol)}
                                    \${generateTreeItem('Cross-Border Fee', data.crossBorder, data.volume, meta.symbol)}
                                    \${generateTreeItem('Cross-Currency Fee', data.crossCurrency, data.volume, meta.symbol)}
                                    \${generateTreeItem('Preauth Fee', data.preauth, data.volume, meta.symbol)}
                                    \${generateTreeItem('3DS Fee', data.threeDS, data.volume, meta.symbol)}
                                    \${generateTreeItem('Non-3DS Fee', data.nonThreeDS, data.volume, meta.symbol)}
                                    \${generateTreeItem('VAT', data.vat, data.volume, meta.symbol)}
                                    \${generateTreeItem('WHT', data.wht, data.volume, meta.symbol)}
                                    \${generateTreeItem('GRT', data.grt, data.volume, meta.symbol)}
                                    \${generateTreeItem('ST', data.st, data.volume, meta.symbol)}
                                    \${generateTreeItem('Net Acquirer Markup', data.netMarkup, data.volume, meta.symbol, true)}
                                </div>
                            </div>
                        </div>

                        <div class="total-section">
                            <div class="total-label">Total MDR</div>
                            <div class="total-value">\${meta.symbol}\${Math.abs(data.mdr).toFixed(2)} (\${mdrPct.toFixed(2)}%)</div>
                        </div>
                    \`;
                    regionsGrid.appendChild(card);
                });
            });

            // Animate bars
            setTimeout(() => {
                const bars = document.querySelectorAll('.fee-bar-fill');
                bars.forEach(bar => {
                    const width = bar.style.width;
                    bar.style.width = '0%';
                    setTimeout(() => {
                        bar.style.width = width;
                    }, 100);
                });
            }, 100);
        }

        function generateTreeItem(label, amount, volume, symbol, isLast = false) {
            if (Math.abs(amount) < 0.001) return '';
            const pct = volume ? Math.abs(amount / volume * 100) : 0;
            const icon = isLast ? '‚îî‚îÄ' : '‚îú‚îÄ';
            return \`
                <div class="fee-tree-item">
                    <div class="fee-tree-label">
                        <span class="fee-tree-icon">\${icon}</span> \${label}
                    </div>
                    <div class="fee-tree-amount">\${symbol}\${Math.abs(amount).toFixed(2)} (\${pct.toFixed(3)}%)</div>
                </div>
            \`;
        }

        // Animation for bars (initial load)
        window.addEventListener('load', function() {
            const bars = document.querySelectorAll('.fee-bar-fill');
            bars.forEach(bar => {
                const width = bar.style.width;
                bar.style.width = '0%';
                setTimeout(() => {
                    bar.style.width = width;
                }, 100);
            });
        });

        // Modal functions
        function showModal(feeType, region, cardType) {
            const modal = document.getElementById('calculationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');

            let content = '';
            let title = '';

            if (feeType === 'ic') {
                title = 'üí± IC (Interchange Fee) Calculation';
                content = `
                < div class="calculation-section" >
                        <h3>üìä Data Source</h3>
                        <p>This value comes from the NomuPay Daily Funding Report CSV file.</p>
                        <div class="calc-row">
                            <span class="calc-label">CSV Column:</span>
                            <span class="calc-value"><span class="column-tag">Interchange Amount</span></span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Region Filter:</span>
                            <span class="calc-value">${region}</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Card Type Filter:</span>
                            <span class="calc-value">${cardType}</span>
                        </div>
                    </div >

                    <div class="calculation-section">
                        <h3>üî¢ Calculation Method</h3>
                        <div class="formula-box">
                            IC Total = SUM(Interchange Amount)<br>
                            WHERE Merchant contains "${region}" AND Card Type = "${cardType}"
                        </div>
                        <p><strong>What is IC (Interchange)?</strong></p>
                        <p>The Interchange Fee is paid to the card-issuing bank. It varies based on:</p>
                        <ul>
                            <li>Card type (Credit vs Debit)</li>
                            <li>Card brand (Visa, Mastercard, etc.)</li>
                            <li>Transaction type (ECOM, POS, etc.)</li>
                            <li>Issuer country vs Merchant country</li>
                        </ul>
                    </div>

                    <div class="calculation-section">
                        <h3>üìÅ CSV File Structure</h3>
                        <p>The script reads from:</p>
                        <span class="column-tag">daily_funding_report_*.csv</span>
                        <p style="margin-top: 10px;">Column 38 in the CSV contains the Interchange Amount per transaction.</p>
                    </div>
            `;
            } else if (feeType === 'first') {
                title = 'üè¶ 1st Plus (Scheme Fee) Calculation';
                content = `
                < div class="calculation-section" >
                        <h3>üìä Data Source</h3>
                        <p>This value comes from the NomuPay Daily Funding Report CSV file.</p>
                        <div class="calc-row">
                            <span class="calc-label">CSV Column:</span>
                            <span class="calc-value"><span class="column-tag">Scheme Fee Bucket Amount</span></span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Region Filter:</span>
                            <span class="calc-value">${region}</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Card Type Filter:</span>
                            <span class="calc-value">${cardType}</span>
                        </div>
                    </div >

                    <div class="calculation-section">
                        <h3>üî¢ Calculation Method</h3>
                        <div class="formula-box">
                            1st Plus Total = SUM(Scheme Fee Bucket Amount)<br>
                            WHERE Merchant contains "${region}" AND Card Type = "${cardType}"
                        </div>
                    </div>

                    <div class="calculation-section">
                        <h3>üí° What is 1st Plus (Scheme Fee)?</h3>
                        <p>The Scheme Fee is charged by the card networks (Visa, Mastercard, etc.) for:</p>
                        <ul>
                            <li>Processing transactions through their network</li>
                            <li>Authorization and clearing services</li>
                            <li>Network maintenance and security</li>
                            <li>Cross-border transaction processing</li>
                        </ul>
                    </div>

                    <div class="calculation-section">
                        <h3>üìÅ CSV File Structure</h3>
                        <p>Column 50 in the CSV: <span class="column-tag">Scheme Fee Bucket Amount</span></p>
                    </div>
            `;
            } else if (feeType === 'second') {
                title = 'üîß 2nd Plus (Acquirer Markup) Calculation';
                content = `
                < div class="calculation-section" >
                        <h3>üìä Data Source</h3>
                        <p>This is a <strong>calculated value</strong> derived from multiple CSV columns.</p>
                    </div >

                    <div class="calculation-section">
                        <h3>üî¢ Calculation Formula</h3>
                        <div class="formula-box">
                            2nd Plus = MDR - IC - 1st Plus
                        </div>
                        <p>Where:</p>
                        <div class="calc-row">
                            <span class="calc-label">MDR:</span>
                            <span class="calc-value"><span class="column-tag">MDR Amount</span> (Column 36)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">IC:</span>
                            <span class="calc-value"><span class="column-tag">Interchange Amount</span> (Column 38)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">1st Plus:</span>
                            <span class="calc-value"><span class="column-tag">Scheme Fee Bucket Amount</span> (Column 50)</span>
                        </div>
                    </div>

                    <div class="calculation-section">
                        <h3>üîß 2nd Plus Components Breakdown</h3>
                        <p>The 2nd Plus is further broken down into these CSV columns:</p>
                        <div class="calc-row">
                            <span class="calc-label">Gateway Fee:</span>
                            <span class="calc-value"><span class="column-tag">Gateway Fee Amount</span> (Col 56)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Authorization Fee:</span>
                            <span class="calc-value"><span class="column-tag">Authorization Amount</span> (Col 44)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Clearing Fee:</span>
                            <span class="calc-value"><span class="column-tag">Clearing Amount</span> (Col 46)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Cross-Border Fee:</span>
                            <span class="calc-value"><span class="column-tag">Cross Border Amount</span> (Col 40)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">Cross-Currency Fee:</span>
                            <span class="calc-value"><span class="column-tag">Cross Currency Amount</span> (Col 42)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">3DS Fee:</span>
                            <span class="calc-value"><span class="column-tag">Three Ds Amount</span> (Col 54)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">VAT:</span>
                            <span class="calc-value"><span class="column-tag">VAT Amount</span> (Col 60)</span>
                        </div>
                        <div class="calc-row">
                            <span class="calc-label">WHT:</span>
                            <span class="calc-value"><span class="column-tag">WHT Amount</span> (Col 64)</span>
                        </div>
                    </div>

                    <div class="calculation-section">
                        <h3>üí∞ Net Acquirer Markup</h3>
                        <div class="formula-box">
                            Net Markup = 2nd Plus - (Gateway + Auth + Clearing + ... + Taxes)
                        </div>
                        <p>This is the <strong>pure profit margin</strong> retained by the acquirer after all operational costs.</p>
                    </div>

                    <div class="calculation-section">
                        <h3>üí° What is 2nd Plus (Acquirer Markup)?</h3>
                        <p>The Acquirer Markup covers:</p>
                        <ul>
                            <li>Gateway processing fees (3DS, Capture, Debit, Refund events)</li>
                            <li>Authorization and clearing operational costs</li>
                            <li>Risk management and fraud prevention</li>
                            <li>Cross-border and currency conversion handling</li>
                            <li>Taxes (VAT, WHT, GRT, ST)</li>
                            <li>Acquirer profit margin</li>
                        </ul>
                    </div>
                `;
            }

            modalTitle.textContent = title;
            modalBody.innerHTML = content;
            modal.style.display = 'block';
        }

        function closeModal() {
            document.getElementById('calculationModal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('calculationModal');
            if (event.target == modal) {
                closeModal();
            }
        }
    </script>
</body>

</html>